# 天翼云AI电脑保活工具使用指南

## 项目简介

本工具用于保持天翼云AI电脑的在线状态，防止因长时间未操作而自动关机。

---

## 快速开始

### 方式一：使用 login.sh 脚本（推荐）

```bash
# 1. 运行登录脚本
./login.sh 手机号 密码

# 2. 使用生成的 session.json 运行 Docker
docker run -v $(pwd)/session.json:/app/session.json your-image
```

### 方式二：从浏览器获取配置

如果登录脚本无法使用（例如需要手机验证码），请按以下步骤手动获取配置。

---

## 详细配置步骤

### 步骤1：获取 deviceCode

deviceCode 是设备唯一标识，存储在浏览器的 localStorage 中。

1. 打开 [天翼云电脑](https://pc.ctyun.cn/) 并登录
2. 按 **F12** 打开开发者工具
3. 切换到 **Application**（应用程序）标签
4. 左侧找到 **Local Storage** → **https://pc.ctyun.cn**
5. 找到 key 为 `deviceCode` 的项，复制其值

![获取deviceCode示意图](示意：在Application > Local Storage中查找deviceCode)

**deviceCode 格式示例：** `web_sgrllN1zCxINVbWc5IZYqQK5dJk0q4qz`

---

### 步骤2：获取 secretKey 等登录信息

1. 在浏览器中登录天翼云电脑
2. 按 **F12** → 切换到 **Network**（网络）标签
3. 在天翼云电脑页面刷新或执行任意操作
4. 在 Network 中搜索 `login` 或 `list`
5. 点击请求，查看 **Response**（响应）中的 JSON 数据

需要获取的字段：
- `userId` - 用户ID
- `tenantId` - 租户ID
- `secretKey` - 密钥（每次登录会变化）
- `userAccount` - 用户账号

---

### 步骤3：获取 desktopId

1. 在 Network 中搜索 `list`
2. 找到 `/api/desktop/client/list` 请求
3. 查看 Response 中的 `desktopList[0].desktopId`

**desktopId 格式示例：** `22130831`

---

### 步骤4：创建 session.json

在项目目录创建 `session.json` 文件：

```json
{
    "userAccount": "ydn_c_20251212_xxxxx",
    "userId": 17531421,
    "tenantId": 15,
    "secretKey": "xxxxxxxxxxxxxxxxxxxxxxxxx",
    "mobilephone": "13980779568",
    "deviceCode": "web_sgrllN1zCxINVbWc5IZYqQK5dJk0q4qz",
    "desktopId": "22130831",
    "version": "103020001"
}
```

---

## Docker 部署

### 构建镜像

```bash
# 发布应用
dotnet publish -c Release -o publish

# 构建 Docker 镜像
docker build -t ctyun-keepalive .
```

### 运行容器

```bash
docker run -d \
  --name ctyun \
  --restart unless-stopped \
  -v /path/to/session.json:/app/session.json \
  ctyun-keepalive
```

### 查看日志

```bash
docker logs -f ctyun
```

---

## 常见问题

### Q: 出现 "登录失败，请重试！" (code:30060)

**原因：** deviceCode 不匹配或 session 过期

**解决方法：**
1. 确认 session.json 中的 deviceCode 与浏览器一致
2. 重新运行 login.sh 获取新的 session.json

### Q: 出现 "当前登录信息已过期" (code:40010)

**原因：** secretKey 已过期

**解决方法：**
1. 重新运行 login.sh 获取新的 secretKey
2. 或从浏览器重新获取登录信息

### Q: deviceCode 在哪里查看？

见上方 [步骤1：获取 deviceCode](#步骤1获取-devicecode)

### Q: 如何确认云电脑已开机？

1. 登录 [天翼云电脑网页版](https://pc.ctyun.cn/)
2. 查看云电脑状态显示"运行中"（绿色指示灯）

---

## 配置字段说明

| 字段 | 说明 | 是否必填 | 获取方式 |
|------|------|---------|---------|
| `deviceCode` | 设备唯一标识 | ✅ 必填 | 浏览器 localStorage |
| `userId` | 用户ID | ✅ 必填 | 登录响应 |
| `tenantId` | 租户ID | ✅ 必填 | 登录响应 |
| `secretKey` | 会话密钥 | ✅ 必填 | 登录响应（会过期） |
| `desktopId` | 云电脑ID | ✅ 必填 | 设备列表响应 |
| `userAccount` | 用户账号 | 选填 | 登录响应 |
| `mobilephone` | 手机号 | 选填 | 登录使用的手机号 |
| `version` | API版本号 | 选填 | 固定为 `103020001` |

---

## 登录脚本使用说明

### 基本用法

```bash
./login.sh <手机号> <密码>
```

### 示例

```bash
./login.sh 13800138000 mypassword
```

### 脚本功能

1. 自动获取图片验证码并识别
2. 登录获取 secretKey
3. 获取设备列表
4. 生成 session.json 文件

### 注意事项

- 脚本默认使用内置的 deviceCode
- 如需使用浏览器的 deviceCode，修改脚本中的 `DEVICE_CODE` 变量
- 验证码识别可能失败，脚本会自动重试最多 5 次

---

## 技术说明

### API 版本

当前使用的 API 版本为 AI 云电脑版本：
- `ctg-version`: `103020001`
- `ctg-appmodel`: `2`

### 签名计算

请求签名格式：
```
MD5(deviceType + timestamp + tenantId + timestamp + userId + version + secretKey)
```

签名需转换为**大写**。

---

## 更新日志

### v1.0.8
- 支持 AI 云电脑 (ctg-appmodel: 2)
- 更新 API 版本号
- 添加 Session 登录模式
- 签名转大写

---

## 联系与反馈

如有问题，请提交 Issue 或联系开发者。
